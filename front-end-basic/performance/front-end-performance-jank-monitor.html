<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端性能优化--卡顿链路追踪 | 被删的前端游乐场</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/front-end-playground/assets/css/0.styles.a0b3413c.css" as="style"><link rel="preload" href="/front-end-playground/assets/js/app.2de7f1bc.js" as="script"><link rel="preload" href="/front-end-playground/assets/js/2.e5aa9928.js" as="script"><link rel="preload" href="/front-end-playground/assets/js/3.ab142917.js" as="script"><link rel="preload" href="/front-end-playground/assets/js/94.5de7782c.js" as="script">
    <link rel="stylesheet" href="/front-end-playground/assets/css/0.styles.a0b3413c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/front-end-playground/" class="home-link router-link-active"><!----> <span class="site-name">被删的前端游乐场</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/front-end-playground/" class="nav-link">概述</a></div><div class="nav-item"><a href="/front-end-playground/front-end-basic/" class="nav-link router-link-active">前端领域</a></div><div class="nav-item"><a href="/front-end-playground/vue/" class="nav-link">Vue学习</a></div><div class="nav-item"><a href="/front-end-playground/wxapp/" class="nav-link">小程序学习</a></div><div class="nav-item"><a href="/front-end-playground/angular/" class="nav-link">Angular学习</a></div><div class="nav-item"><a href="/front-end-playground/front-end-others/" class="nav-link">百家齐放</a></div><div class="nav-item"><a href="/front-end-playground/front-end-addon/" class="nav-link">前端的进击</a></div><div class="nav-item"><a href="/front-end-playground/front-end-work/" class="nav-link">前端与工作</a></div><div class="nav-item"><a href="/front-end-playground/faq.html" class="nav-link">FAQ</a></div> <a href="https://github.com/godbasin/front-end-playground" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/front-end-playground/" class="nav-link">概述</a></div><div class="nav-item"><a href="/front-end-playground/front-end-basic/" class="nav-link router-link-active">前端领域</a></div><div class="nav-item"><a href="/front-end-playground/vue/" class="nav-link">Vue学习</a></div><div class="nav-item"><a href="/front-end-playground/wxapp/" class="nav-link">小程序学习</a></div><div class="nav-item"><a href="/front-end-playground/angular/" class="nav-link">Angular学习</a></div><div class="nav-item"><a href="/front-end-playground/front-end-others/" class="nav-link">百家齐放</a></div><div class="nav-item"><a href="/front-end-playground/front-end-addon/" class="nav-link">前端的进击</a></div><div class="nav-item"><a href="/front-end-playground/front-end-work/" class="nav-link">前端与工作</a></div><div class="nav-item"><a href="/front-end-playground/faq.html" class="nav-link">FAQ</a></div> <a href="https://github.com/godbasin/front-end-playground" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0" style="padding-top:;"><!----> <p class="sidebar-heading"><span>前端技能</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0" style="padding-top:10px;"><div class="kitty-main" data-v-2b653b36><span class="stand" data-v-2b653b36></span> <div class="cat" data-v-2b653b36><div class="body" data-v-2b653b36></div> <div class="head" data-v-2b653b36><div class="ear" data-v-2b653b36></div> <div class="ear" data-v-2b653b36></div></div> <div class="face" data-v-2b653b36><div class="nose" data-v-2b653b36></div> <div class="whisker-container" data-v-2b653b36><div class="whisker" data-v-2b653b36></div> <div class="whisker" data-v-2b653b36></div></div> <div class="whisker-container" data-v-2b653b36><div class="whisker" data-v-2b653b36></div> <div class="whisker" data-v-2b653b36></div></div></div> <div class="tail-container" data-v-2b653b36><div class="tail" data-v-2b653b36><div class="tail" data-v-2b653b36><div class="tail" data-v-2b653b36><div class="tail" data-v-2b653b36><div class="tail" data-v-2b653b36><div class="tail" data-v-2b653b36><div class="tail" data-v-2b653b36></div></div></div></div></div></div></div></div></div></div> <p class="sidebar-heading open"><span>前端性能优化</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-long-task.html" class="sidebar-link">让你的长任务在 50 毫秒内结束</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-optimization.html" class="sidebar-link">前端性能优化--归纳篇</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-startup.html" class="sidebar-link">前端性能优化--加载流程篇</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-render.html" class="sidebar-link">前端性能优化--渲染篇</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-no-responding.html" class="sidebar-link">前端性能优化--卡顿篇</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-canvas.html" class="sidebar-link">前端性能优化--Canvas篇</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-container.html" class="sidebar-link">前端性能优化--容器篇</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-ssr.html" class="sidebar-link">前端性能优化--SSR篇</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-optimization-project.html" class="sidebar-link">前端性能优化--项目管理篇</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-no-response-solution.html" class="sidebar-link">前端性能优化--卡顿的监控和定位</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-jank-detect.html" class="sidebar-link">前端性能优化--用户卡顿检测</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-metric.html" class="sidebar-link">前端性能优化--数据指标体系</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-jank-heartbeat-monitor.html" class="sidebar-link">前端性能优化--卡顿心跳检测</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-jank-monitor.html" aria-current="page" class="active sidebar-link">前端性能优化--卡顿链路追踪</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-playground/front-end-basic/performance/front-end-performance-jank-monitor.html#卡顿监控实现" class="sidebar-link">卡顿监控实现</a></li><li class="sidebar-sub-header"><a href="/front-end-playground/front-end-basic/performance/front-end-performance-jank-monitor.html#结束语" class="sidebar-link">结束语</a></li></ul></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-r-tree.html" class="sidebar-link">前端性能优化--R 树的使用</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-task-schedule.html" class="sidebar-link">前端性能优化--任务管理和调度</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-array-performance.html" class="sidebar-link">前端性能优化--JavaScript 数组解构</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-flyweight-pattern.html" class="sidebar-link">前端性能优化--享元模式</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-code-detail.html" class="sidebar-link">前端性能优化--代码习惯</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-binary-attribute.html" class="sidebar-link">前端性能优化--二进制压缩数据内容</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-analyze.html" class="sidebar-link">补齐Web前端性能分析的工具盲点</a></li><li><a href="/front-end-playground/front-end-basic/performance/front-end-performance-about-performanceobserver.html" class="sidebar-link">有趣的 PerformanceObserver</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0" style="padding-top:;"><!----> <p class="sidebar-heading"><span>复杂渲染引擎架构与设计</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0" style="padding-top:;"><!----> <p class="sidebar-heading"><span>前端架构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0" style="padding-top:;"><!----> <p class="sidebar-heading"><span>前端深入理解</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0" style="padding-top:;"><!----> <p class="sidebar-heading"><span>前端入门</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>我们在上一篇<a href="/front-end-playground/front-end-basic/performance/front-end-performance-jank-heartbeat-monitor.html">《前端性能优化--卡顿心跳检测》</a>一文中介绍过基于<code>requestAnimationFrame</code>的卡顿的检测方案实现，这一篇文章我们将会介绍基于该心跳检测方案，要怎么实现链路追踪，来找到产生卡顿的地方。</p> <h2 id="卡顿监控实现"><a href="#卡顿监控实现" class="header-anchor">#</a> 卡顿监控实现</h2> <p>上一篇我们提到的心跳检测，实现的功能很简单，就是卡顿和心跳事件、开始和停止，那么我们卡顿监控使用的时候也比较简单：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">JankMonitor</span> <span class="token punctuation">{</span>
  <span class="token comment">// 心跳 SDK</span>
  <span class="token keyword">private</span> heartBeatMonitor<span class="token operator">:</span> HeartbeatMonitor<span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始化并绑定事件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>heartBeatMonitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeartbeatMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// PS：此处 addEventListener 为伪代码，可自行实现一个事件转发器</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>heartBeatMonitor<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;jank&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleJank<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>heartBeatMonitor<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;heartbeat&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleHeartBeat<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 可以初始化的时候就启动</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>heartBeatMonitor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 处理卡顿
   */</span>
  <span class="token keyword">private</span> <span class="token function">handleJank</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">/**
   * 处理心跳
   */</span>
  <span class="token keyword">private</span> <span class="token function">handleHeartBeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这时候可以检测到卡顿了，接下来便是在卡顿发生的时候找到问题并上报了。前面<a href="/front-end-playground/front-end-basic/performance/front-end-performance-no-response-solution.html">《前端性能优化--卡顿的监控和定位》</a>中有大致介绍堆栈的方法，这里我们来介绍下具体要怎么实现吧~</p> <h3 id="堆栈追踪卡顿"><a href="#堆栈追踪卡顿" class="header-anchor">#</a> 堆栈追踪卡顿</h3> <p>同样的，假设我们通过打堆栈的方式来追踪，堆栈信息包括：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">interface</span> <span class="token class-name">IJankLog</span> <span class="token punctuation">{</span>
  <span class="token keyword">module</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  action<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  logTime<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么，我们的卡顿检测还需要对外提供<code>log</code>打堆栈的能力：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">JankMonitor</span> <span class="token punctuation">{</span>
  <span class="token comment">// 卡顿链路堆栈</span>
  <span class="token keyword">private</span> jankLogStack<span class="token operator">:</span> IJankLog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">log</span><span class="token punctuation">(</span>logPosition<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">module</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> action<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>jankLogStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span>logPosition<span class="token punctuation">,</span>
      logTime<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">handleHeartBeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 心跳的时候，可以将堆栈清空，因为正常心跳发生意味着没有卡顿，此时堆栈内信息可以移除</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>jankLogStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 清空后，添加心跳信息，方便计算耗时</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>jankLogStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token keyword">module</span><span class="token operator">:</span> <span class="token string">&quot;jank&quot;</span><span class="token punctuation">,</span>
      action<span class="token operator">:</span> <span class="token string">&quot;heartbeat&quot;</span><span class="token punctuation">,</span>
      logTime<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...其他内容省略</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当卡顿发生时，我们可以根据堆栈计算出卡顿产生的位置：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">JankMonitor</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> jankLogStack<span class="token operator">:</span> IJankLog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token function">handleJank</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> jankPosition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calculateJankPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 拿到卡顿位置后，可以进行上报</span>
    <span class="token comment">// PS: reportJank 为伪代码，可以根据项目情况自行实现</span>
    <span class="token function">reportJank</span><span class="token punctuation">(</span>jankPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 打印异常</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;产生了卡顿，位置信息为：&quot;</span><span class="token punctuation">,</span> jankPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 上报结束后，则需要清空堆栈，继续监听</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>jankLogStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...其他内容省略</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下面我们来详细看一下，要怎么计算出卡顿产生的位置。</p> <h3 id="卡顿位置定位"><a href="#卡顿位置定位" class="header-anchor">#</a> 卡顿位置定位</h3> <p>我们在代码中，使用<code>log</code>方法来打关键链路日志，那么我们拿到的堆栈信息大概会长这样：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>jankLogStack <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">module</span><span class="token operator">:</span> <span class="token string">&quot;数据模块&quot;</span><span class="token punctuation">,</span>
    action<span class="token operator">:</span> <span class="token string">&quot;拉取数据&quot;</span><span class="token punctuation">,</span>
    logTime<span class="token operator">:</span> logTime1<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">module</span><span class="token operator">:</span> <span class="token string">&quot;数据模块&quot;</span><span class="token punctuation">,</span>
    action<span class="token operator">:</span> <span class="token string">&quot;加载数据&quot;</span><span class="token punctuation">,</span>
    logTime<span class="token operator">:</span> logTime2<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">module</span><span class="token operator">:</span> <span class="token string">&quot;Feature 模块&quot;</span><span class="token punctuation">,</span>
    action<span class="token operator">:</span> <span class="token string">&quot;处理数据&quot;</span><span class="token punctuation">,</span>
    logTime<span class="token operator">:</span> logTime3<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">module</span><span class="token operator">:</span> <span class="token string">&quot;渲染模块&quot;</span><span class="token punctuation">,</span>
    action<span class="token operator">:</span> <span class="token string">&quot;渲染数据&quot;</span><span class="token punctuation">,</span>
    logTime<span class="token operator">:</span> logTime4<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>当卡顿发生的时候，我们可以将堆栈取出来计算最大耗时的位置：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">JankMonitor</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> jankLogStack<span class="token operator">:</span> IJankLog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token function">calculateJankPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 记录产生卡顿的位置</span>
    <span class="token keyword">let</span> jankPosition<span class="token punctuation">;</span>
    <span class="token comment">// 记录最大耗时</span>
    <span class="token keyword">let</span> maxCostTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 遍历堆栈，计算每一步耗时</span>
    <span class="token comment">// 第一个信息为心跳信息，可从第二个开始算起</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jankLogStack<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 上个位置</span>
      <span class="token keyword">const</span> previousPosition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jankLogStack<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 当前位置</span>
      <span class="token keyword">const</span> currentPosition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jankLogStack<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 链路耗时</span>
      <span class="token keyword">const</span> costTime <span class="token operator">=</span> currentPosition<span class="token punctuation">.</span>logTime <span class="token operator">-</span> previousPosition<span class="token punctuation">.</span>logTime<span class="token punctuation">;</span>

      <span class="token comment">// 可以将链路打出来，方便定位</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>previousPosition<span class="token punctuation">.</span>module<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>previousPosition<span class="token punctuation">.</span>action<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -&gt; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>currentPosition<span class="token punctuation">.</span>module<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>currentPosition<span class="token punctuation">.</span>action<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, 耗时 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>costTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ms</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 找出最大耗时和最大位置</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>costTime <span class="token operator">&gt;</span> maxCostTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        maxCostTime <span class="token operator">=</span> costTime<span class="token punctuation">;</span>
        jankPosition <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token operator">...</span>currentPosition<span class="token punctuation">,</span>
          costTime<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> jankPosition<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...其他内容省略</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样我们就可以计算出产生卡顿时，代码执行的整个链路（需要使用<code>log</code>记录堆栈），同时可找到耗时最大的位置并进行上报。当然，有时候卡顿产生并不只是一个地方，这里也可以调整为将执行超过一定时间的链路全部进行上报。</p> <p>现在，我们可以拿到产生卡顿的有效位置，当然前提是需要使用<code>log</code>方法记录关键的链路信息。为了方便，我们可以将其做成一个装饰器来使用。</p> <h3 id="janktrace-装饰器"><a href="#janktrace-装饰器" class="header-anchor">#</a> @jankTrace 装饰器</h3> <p>该装饰器功能很简单，就是调用<code>JankMonitor.log</code>方法：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/**
 * 装饰器，可用于装饰类中的成员方法和箭头函数
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> JankTrace<span class="token operator">:</span> MethodDecorator <span class="token operator">|</span> <span class="token function-variable function">PropertyDecorator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  target<span class="token punctuation">,</span>
  propertyKey<span class="token punctuation">,</span>
  descriptor
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> className <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token keyword">constructor</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
  <span class="token keyword">const</span> methodName <span class="token operator">=</span> propertyKey<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> isProperty <span class="token operator">=</span> <span class="token operator">!</span>descriptor<span class="token punctuation">;</span>
  <span class="token keyword">const</span> originalMethod <span class="token operator">=</span> isProperty
    <span class="token operator">?</span> <span class="token punctuation">(</span>target <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">[</span>propertyKey<span class="token punctuation">]</span>
    <span class="token operator">:</span> descriptor<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> originalMethod <span class="token operator">!==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;JankTrace decorator can only be applied to methods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token function-variable function">newFunction</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 打印卡顿堆栈</span>
    jankMonitor<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      moduleValue<span class="token operator">:</span> className<span class="token punctuation">,</span>
      actionValue<span class="token operator">:</span> methodName<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> syncResult <span class="token operator">=</span> <span class="token function">originalMethod</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> syncResult<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isProperty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>target <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">[</span>propertyKey<span class="token punctuation">]</span> <span class="token operator">=</span> newFunction<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    descriptor<span class="token operator">!</span><span class="token punctuation">.</span>value <span class="token operator">=</span> newFunction <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>至此，我们可以直接在一些类方法上去添加装饰器，来实现自动跟踪卡顿链路：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">DataLoader</span> <span class="token punctuation">{</span>
  @JankLog
  <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @JankLog
  <span class="token function">loadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="结束语"><a href="#结束语" class="header-anchor">#</a> 结束语</h2> <p>本文简单介绍了卡顿检测的一个实现思路，实际上在项目中还有很多其他问题需要考虑，比如需要设置堆栈上限、状态管理等等。</p> <p>技术方案在项目中落地时，都需要因地制宜做些调整，来更好地适配自己的项目滴~</p></div> <!----> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/godbasin/front-end-playground/edit/sourcecode/docs/front-end-basic/performance/front-end-performance-jank-monitor.md" target="_blank" rel="noopener noreferrer">帮阿猪改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <blockquote>部分文章中使用了一些网站的截图，如果涉及侵权，请告诉我删一下谢谢~</blockquote> <div style="margin-top:30px;"><div class="el-row" style="margin-left:-10px;margin-right:-10px;"><div class="el-col el-col-24 el-col-sm-0 el-col-md-2 el-col-lg-4" style="padding-left:10px;padding-right:10px;display:block;"><div style="width:1px;height:1px;"></div></div> <div class="el-col el-col-24 el-col-sm-24 el-col-md-18 el-col-lg-16" style="padding-left:10px;padding-right:10px;"><div class="el-card box-card is-always-shadow"><div class="el-card__header"><div class="clearfix"><span>温馨提示喵</span></div></div><div class="el-card__body"> <div class="el-row" style="margin-left:-10px;margin-right:-10px;"><div class="el-col el-col-24 el-col-xs-24 el-col-sm-12" style="padding-left:10px;padding-right:10px;"><div class="el-image"><div class="image-slot"><img src="https://github-imglib-1255459943.cos.ap-chengdu.myqcloud.com/assets/img/loading.gif" style="width:100%;"></div><!----></div></div> <div class="el-col el-col-24 el-col-xs-24 el-col-sm-12" style="padding-left:10px;padding-right:10px;"><div class="copyright-text"><div>本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</div> <div>出处：被删的前端游乐场</div> <div>作者：<a href="https://github.com/godbasin" target="_blank">被删</a></div></div></div></div></div></div></div></div></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/front-end-playground/front-end-basic/performance/front-end-performance-jank-heartbeat-monitor.html" class="prev">
          前端性能优化--卡顿心跳检测
        </a></span> <span class="next"><a href="/front-end-playground/front-end-basic/performance/front-end-performance-r-tree.html">
          前端性能优化--R 树的使用
        </a>
        →
      </span></p></div>  <div class="gitalk-container theme-default-content"><div id="gitalk-container" class="content"></div></div></main> <div id="kitty-container"><span><div role="tooltip" id="el-popover-4708" aria-hidden="true" class="el-popover el-popper" style="width:undefinedpx;display:none;"><!----><img src="https://github-imglib-1255459943.cos.ap-chengdu.myqcloud.com/2code2.jpg" class="image"> <div class="text">牡羊猪的猫粮罐</div> </div><span class="el-popover__reference-wrapper"><div id="kitty" style="background:url(https://github-imglib-1255459943.cos.ap-chengdu.myqcloud.com/assets/img/kitty1.svg);"></div></span></span> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="牡羊猪是这样渐渐胖成猪的喵（点击图片可以切换噢）" class="el-dialog" style="margin-top:15vh;"><div class="el-dialog__header"><span class="el-dialog__title">牡羊猪是这样渐渐胖成猪的喵（点击图片可以切换噢）</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><!----></div></div></div></div><div class="global-ui"></div></div>
    <script src="/front-end-playground/assets/js/app.2de7f1bc.js" defer></script><script src="/front-end-playground/assets/js/2.e5aa9928.js" defer></script><script src="/front-end-playground/assets/js/3.ab142917.js" defer></script><script src="/front-end-playground/assets/js/94.5de7782c.js" defer></script>
  </body>
</html>
