<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>13.Ivy编译器之AOT/JIT | 被删的前端游乐场</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/front-end-playground/assets/css/0.styles.a0b3413c.css" as="style"><link rel="preload" href="/front-end-playground/assets/js/app.c4b53b67.js" as="script"><link rel="preload" href="/front-end-playground/assets/js/2.e5aa9928.js" as="script"><link rel="preload" href="/front-end-playground/assets/js/3.ab142917.js" as="script"><link rel="preload" href="/front-end-playground/assets/js/32.26c2dfa8.js" as="script">
    <link rel="stylesheet" href="/front-end-playground/assets/css/0.styles.a0b3413c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/front-end-playground/" class="home-link router-link-active"><!----> <span class="site-name">被删的前端游乐场</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/front-end-playground/" class="nav-link">概述</a></div><div class="nav-item"><a href="/front-end-playground/front-end-basic/" class="nav-link">前端领域</a></div><div class="nav-item"><a href="/front-end-playground/vue/" class="nav-link">Vue学习</a></div><div class="nav-item"><a href="/front-end-playground/wxapp/" class="nav-link">小程序学习</a></div><div class="nav-item"><a href="/front-end-playground/angular/" class="nav-link router-link-active">Angular学习</a></div><div class="nav-item"><a href="/front-end-playground/front-end-others/" class="nav-link">百家齐放</a></div><div class="nav-item"><a href="/front-end-playground/front-end-addon/" class="nav-link">前端的进击</a></div><div class="nav-item"><a href="/front-end-playground/front-end-work/" class="nav-link">前端与工作</a></div><div class="nav-item"><a href="/front-end-playground/faq.html" class="nav-link">FAQ</a></div> <a href="https://github.com/godbasin/front-end-playground" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/front-end-playground/" class="nav-link">概述</a></div><div class="nav-item"><a href="/front-end-playground/front-end-basic/" class="nav-link">前端领域</a></div><div class="nav-item"><a href="/front-end-playground/vue/" class="nav-link">Vue学习</a></div><div class="nav-item"><a href="/front-end-playground/wxapp/" class="nav-link">小程序学习</a></div><div class="nav-item"><a href="/front-end-playground/angular/" class="nav-link router-link-active">Angular学习</a></div><div class="nav-item"><a href="/front-end-playground/front-end-others/" class="nav-link">百家齐放</a></div><div class="nav-item"><a href="/front-end-playground/front-end-addon/" class="nav-link">前端的进击</a></div><div class="nav-item"><a href="/front-end-playground/front-end-work/" class="nav-link">前端与工作</a></div><div class="nav-item"><a href="/front-end-playground/faq.html" class="nav-link">FAQ</a></div> <a href="https://github.com/godbasin/front-end-playground" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0" style="padding-top:10px;"><div class="kitty-main" data-v-2b653b36><span class="stand" data-v-2b653b36></span> <div class="cat" data-v-2b653b36><div class="body" data-v-2b653b36></div> <div class="head" data-v-2b653b36><div class="ear" data-v-2b653b36></div> <div class="ear" data-v-2b653b36></div></div> <div class="face" data-v-2b653b36><div class="nose" data-v-2b653b36></div> <div class="whisker-container" data-v-2b653b36><div class="whisker" data-v-2b653b36></div> <div class="whisker" data-v-2b653b36></div></div> <div class="whisker-container" data-v-2b653b36><div class="whisker" data-v-2b653b36></div> <div class="whisker" data-v-2b653b36></div></div></div> <div class="tail-container" data-v-2b653b36><div class="tail" data-v-2b653b36><div class="tail" data-v-2b653b36><div class="tail" data-v-2b653b36><div class="tail" data-v-2b653b36><div class="tail" data-v-2b653b36><div class="tail" data-v-2b653b36><div class="tail" data-v-2b653b36></div></div></div></div></div></div></div></div></div></div> <p class="sidebar-heading open"><span>Angular框架解读</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/front-end-playground/angular/deep-into-angular/angular-design-0-prestart.html" class="sidebar-link">0.预热篇</a></li><li><a href="/front-end-playground/angular/deep-into-angular/angular-design-metadata.html" class="sidebar-link">1.元数据和装饰器</a></li><li><a href="/front-end-playground/angular/deep-into-angular/angular-design-dom-define.html" class="sidebar-link">2.视图抽象定义</a></li><li><a href="/front-end-playground/angular/deep-into-angular/angular-design-zonejs.html" class="sidebar-link">3.Zone区域之zone.js</a></li><li><a href="/front-end-playground/angular/deep-into-angular/angular-design-zone-ngzone.html" class="sidebar-link">4.Zone区域之ngZone</a></li><li><a href="/front-end-playground/angular/deep-into-angular/angular-design-module.html" class="sidebar-link">5.模块化组织</a></li><li><a href="/front-end-playground/angular/deep-into-angular/angular-design-di-1-basic-concepts.html" class="sidebar-link">6.依赖注入的基本概念</a></li><li><a href="/front-end-playground/angular/deep-into-angular/angular-design-di-2-hierarchical-di.html" class="sidebar-link">7.多级依赖注入设计</a></li><li><a href="/front-end-playground/angular/deep-into-angular/angular-design-di-3-bootstrap.html" class="sidebar-link">8.依赖注入的引导过程</a></li><li><a href="/front-end-playground/angular/deep-into-angular/angular-design-ivy-0-design.html" class="sidebar-link">9.Ivy编译器整体设计</a></li><li><a href="/front-end-playground/angular/deep-into-angular/angular-design-ivy-1-view-data-and-node-injector.html" class="sidebar-link">10.Ivy编译器的视图数据和依赖解析</a></li><li><a href="/front-end-playground/angular/deep-into-angular/angular-design-ivy-2-cli-compiler.html" class="sidebar-link">11.Ivy编译器之CLI编译器</a></li><li><a href="/front-end-playground/angular/deep-into-angular/angular-design-ivy-3-mental-model.html" class="sidebar-link">12.Ivy编译器之心智模型</a></li><li><a href="/front-end-playground/angular/deep-into-angular/angular-design-ivy-4-aot-jit.html" aria-current="page" class="active sidebar-link">13.Ivy编译器之AOT/JIT</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-playground/angular/deep-into-angular/angular-design-ivy-4-aot-jit.html#jit" class="sidebar-link">JIT</a></li><li class="sidebar-sub-header"><a href="/front-end-playground/angular/deep-into-angular/angular-design-ivy-4-aot-jit.html#aot" class="sidebar-link">AOT</a></li><li class="sidebar-sub-header"><a href="/front-end-playground/angular/deep-into-angular/angular-design-ivy-4-aot-jit.html#结束语" class="sidebar-link">结束语</a></li></ul></li><li><a href="/front-end-playground/angular/deep-into-angular/angular-design-ivy-5-incremental-dom.html" class="sidebar-link">14.Ivy编译器之增量DOM</a></li><li><a href="/front-end-playground/angular/deep-into-angular/angular-design-ivy-6-detect-change.html" class="sidebar-link">15.Ivy编译器之变更检测</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0" style="padding-top:;"><!----> <p class="sidebar-heading"><span>玩转 Angular</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>作为“为大型前端项目”而设计的前端框架，Angular 其实有许多值得参考和学习的设计，本系列主要用于研究这些设计和功能的实现原理。本文主要介绍 Angular 中的 AOT 和 JIT 相关设计。</p> <p>Angular 应用主要由组件及其 HTML 模板组成。由于浏览器无法直接理解 Angular 所提供的组件和模板，因此 Angular 应用程序需要先进行编译才能在浏览器中运行。</p> <p>在 Angular 中，提供了两种方式编译 Angular 应用：</p> <ul><li>即时编译 (JIT，Just in time)：它会在运行期间在浏览器中编译你的应用</li> <li>预先编译（AOT，Ahead of Time）：它会在构建时编译你的应用和库</li></ul> <h2 id="jit"><a href="#jit" class="header-anchor">#</a> JIT</h2> <p>在 Angular 8 及更早版本中，默认情况下，在应用程序执行期间，将对模板进行编译，这便是 JIT 编译。</p> <h3 id="工作原理"><a href="#工作原理" class="header-anchor">#</a> 工作原理</h3> <p>JIT 编译相对 AOT 而言比较简单，核心逻辑在<code>JitCompiler</code>中。<code>JitCompiler</code>是 Angular 编译器的一个内部模块，它从组件类型开始，提取模板，并最终生成准备链接到应用程序的组件的编译版本。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JitCompiler</span> <span class="token punctuation">{</span>
  <span class="token comment">// 编译过程中的一些解析内容缓存</span>
  <span class="token keyword">private</span> _compiledTemplateCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span>Type<span class="token punctuation">,</span> CompiledTemplate<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> _compiledHostTemplateCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span>Type<span class="token punctuation">,</span> CompiledTemplate<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> _compiledDirectiveWrapperCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span>Type<span class="token punctuation">,</span> Type<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> _compiledNgModuleCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span>Type<span class="token punctuation">,</span> object<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> _sharedStylesheetCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> _addedAotSummaries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span></span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 模块编译相关方法</span>
  <span class="token function">compileModuleSync</span><span class="token punctuation">(</span>moduleType<span class="token operator">:</span> Type<span class="token punctuation">)</span><span class="token operator">:</span> object <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">compileModuleAsync</span><span class="token punctuation">(</span>moduleType<span class="token operator">:</span> Type<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>object<span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">compileModuleAndAllComponentsSync</span><span class="token punctuation">(</span>
    moduleType<span class="token operator">:</span> Type
  <span class="token punctuation">)</span><span class="token operator">:</span> ModuleWithComponentFactories <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">compileModuleAndAllComponentsAsync</span><span class="token punctuation">(</span>
    moduleType<span class="token operator">:</span> Type
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ModuleWithComponentFactories<span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">getComponentFactory</span><span class="token punctuation">(</span>component<span class="token operator">:</span> Type<span class="token punctuation">)</span><span class="token operator">:</span> object <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">loadAotSummaries</span><span class="token punctuation">(</span><span class="token function-variable function">summaries</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于运行时编译，Angular 会传递并编译所有模块，因此在编译模块过程中，还需要为所有嵌套模块加载声明的指令/管道。</p> <p>实际上，在 JIT 中编译这些模块的过程中，需要依赖模块、组件、指令等装饰器的元数据，该过程在 AOT 中是构建时便完成了编译，在 JIT 中由于组件是动态加载和编译的，因此也需要在模板编译过程进行解析和维护。对装饰器中元数据的编译和管理，可参考<a href="/front-end-playground/angular/deep-into-angular/angular-design-metadata.html">《Angular 框架解读--元数据和装饰器》</a>一文。</p> <h3 id="jit-优势"><a href="#jit-优势" class="header-anchor">#</a> JIT 优势</h3> <p>在运行时编译代码，这意味着它不会在构建时进行编译，而是在调用该组件时编译。JIT 在本地调试的情况下，会更有优势：</p> <ol><li>在 JIT 模式下，并非所有代码都会在初始时间编译。只有在应用程序启动时需要的必要组件才会被编译，如果项目中需要某功能并且它不在已编译的代码中，才会编译该功能或组件。</li> <li>JIT 有助于减轻 CPU 的负担，并使应用程序渲染速度更快。</li> <li>使用 JIT 模式和映射文件编译代码，可以在检查模式下查看并链接到源代码。</li></ol> <p>在执行时，Angular 编译器会将这些模板转换为 JavaScript 函数。在一个简单的应用程序中，JIT 编译将生成两个包：</p> <ul><li>main.bundle.js : 63k (21k 缩小)</li> <li>vendor.bundle.js : 3321k (960k 缩小)</li></ul> <p>对<code>vendor.bundle.js</code>文件（使用<code>source-map-explorer</code>）的分析表明，Angular 编译器占总包大小的 35%。这种机制有两个缺点：</p> <ol><li>JavaScript 包太重（显然是因为应用程序源需要在文件<code>vendor.bundle.js</code>中包含编译器）。</li> <li>应用程序将在运行时编译模板，这会影响渲染时间。</li></ol> <p>因此，Angular 提供了 AOT 编译，并在 Angular 9 及后续版本中将其设置为默认值。</p> <h2 id="aot"><a href="#aot" class="header-anchor">#</a> AOT</h2> <p>在浏览器下载和运行代码之前的编译阶段，Angular 预先（AOT）编译器会先把 Angular HTML 和 TypeScript 代码转换成高效的 JavaScript 代码。</p> <h3 id="工作原理-2"><a href="#工作原理-2" class="header-anchor">#</a> 工作原理</h3> <p>实际上，前面我们介绍的 Ivy 编译器中心智模型（参考<a href="/front-end-playground/angular/deep-into-angular/angular-design-ivy-3-mental-model.html">《Angular 框架解读--Ivy 编译器之心智模型》</a>），便是 AOT 的主要工作原理。主要包括：</p> <ul><li>Angular AOT 编译器会提取元数据，来解释应由 Angular 管理的应用程序部分</li> <li>通过在装饰器（例如<code>@Component()</code>）中显式指定元数据，也可以在被装饰的类的构造函数声明中隐式指定元数据</li> <li>元数据告诉 Angular 要如何构造应用程序类的实例并在运行时与它们进行交互</li></ul> <p>至于对装饰器中元数据的处理和编译过程，主要是通过将 Angular 编译集成到 TypeScript 编译器的编译流程中来实现。前面的<a href="/front-end-playground/angular/deep-into-angular/angular-design-ivy-0-design.html">Angular 框架解读--Ivy 编译器</a>系列文章有介绍，因此这里也不过多展开。</p> <p>同样，我们可以找到<code>AotCompiler</code>：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AotCompiler</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> _templateAstCache <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span>StaticSymbol<span class="token punctuation">,</span> <span class="token punctuation">{</span>template<span class="token operator">:</span> TemplateAst<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pipes<span class="token operator">:</span> CompilePipeSummary<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> _analyzedFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> NgAnalyzedFile<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> _analyzedFilesForInjectables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> NgAnalyzedFileWithInjectables<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">analyzeModulesSync</span><span class="token punctuation">(</span>rootFiles<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> NgAnalyzedModules <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">analyzeModulesAsync</span><span class="token punctuation">(</span>rootFiles<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>NgAnalyzedModules<span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">findGeneratedFileNames</span><span class="token punctuation">(</span>fileName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">emitBasicStub</span><span class="token punctuation">(</span>genFileName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> originalFileName<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> GeneratedFile <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">emitTypeCheckStub</span><span class="token punctuation">(</span>genFileName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> originalFileName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> GeneratedFile<span class="token operator">|</span><span class="token keyword">null</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">loadFilesAsync</span><span class="token punctuation">(</span>fileNames<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tsFiles<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>
      <span class="token punctuation">{</span>analyzedModules<span class="token operator">:</span> NgAnalyzedModules<span class="token punctuation">,</span> analyzedInjectables<span class="token operator">:</span> NgAnalyzedFileWithInjectables<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">loadFilesSync</span><span class="token punctuation">(</span>fileNames<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tsFiles<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token punctuation">{</span>analyzedModules<span class="token operator">:</span> NgAnalyzedModules<span class="token punctuation">,</span> analyzedInjectables<span class="token operator">:</span> NgAnalyzedFileWithInjectables<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">emitMessageBundle</span><span class="token punctuation">(</span>analyzeResult<span class="token operator">:</span> NgAnalyzedModules<span class="token punctuation">,</span> locale<span class="token operator">:</span> <span class="token builtin">string</span><span class="token operator">|</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> MessageBundle <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">emitAllPartialModules2</span><span class="token punctuation">(</span>files<span class="token operator">:</span> NgAnalyzedFileWithInjectables<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> PartialModule<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">emitAllImpls</span><span class="token punctuation">(</span>analyzeResult<span class="token operator">:</span> NgAnalyzedModules<span class="token punctuation">)</span><span class="token operator">:</span> GeneratedFile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">listLazyRoutes</span><span class="token punctuation">(</span>entryRoute<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> analyzedModules<span class="token operator">?</span><span class="token operator">:</span> NgAnalyzedModules<span class="token punctuation">)</span><span class="token operator">:</span> LazyRoute<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从对外提供的方法来看，相比于<code>JitCompiler</code>，显然<code>AotCompiler</code>并没有什么编译的过程，更多是解析文件并创建组件。两个<code>Compiler</code>相差很远，但我们可以找到同样包含的一个<code>_compileModule</code>来比较：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AotCompiler</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token function">_compileModule</span><span class="token punctuation">(</span>outputCtx<span class="token operator">:</span> OutputContext<span class="token punctuation">,</span> ngModule<span class="token operator">:</span> CompileNgModuleMetadata<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> providers<span class="token operator">:</span> CompileProviderMetadata<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_options<span class="token punctuation">.</span>locale<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> normalizedLocale <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_options<span class="token punctuation">.</span>locale<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">_</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      providers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        token<span class="token operator">:</span> <span class="token function">createTokenForExternalReference</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reflector<span class="token punctuation">,</span> Identifiers<span class="token punctuation">.</span><span class="token constant">LOCALE_ID</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        useValue<span class="token operator">:</span> normalizedLocale<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_options<span class="token punctuation">.</span>i18nFormat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      providers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        token<span class="token operator">:</span> <span class="token function">createTokenForExternalReference</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reflector<span class="token punctuation">,</span> Identifiers<span class="token punctuation">.</span><span class="token constant">TRANSLATIONS_FORMAT</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        useValue<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_options<span class="token punctuation">.</span>i18nFormat
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_ngModuleCompiler<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>outputCtx<span class="token punctuation">,</span> ngModule<span class="token punctuation">,</span> providers<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JitCompiler</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token function">_compileModule</span><span class="token punctuation">(</span>moduleType<span class="token operator">:</span> Type<span class="token punctuation">)</span><span class="token operator">:</span> object <span class="token punctuation">{</span>
    <span class="token keyword">let</span> ngModuleFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_compiledNgModuleCache<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>moduleType<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ngModuleFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> moduleMeta <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_metadataResolver<span class="token punctuation">.</span><span class="token function">getNgModuleMetadata</span><span class="token punctuation">(</span>moduleType<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> extraProviders <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getExtraNgModuleProviders</span><span class="token punctuation">(</span>moduleMeta<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token punctuation">.</span>reference<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> outputCtx <span class="token operator">=</span> <span class="token function">createOutputContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> compileResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_ngModuleCompiler<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>outputCtx<span class="token punctuation">,</span> moduleMeta<span class="token punctuation">,</span> extraProviders<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ngModuleFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_interpretOrJit</span><span class="token punctuation">(</span>
          <span class="token function">ngModuleJitUrl</span><span class="token punctuation">(</span>moduleMeta<span class="token punctuation">)</span><span class="token punctuation">,</span> outputCtx<span class="token punctuation">.</span>statements<span class="token punctuation">)</span><span class="token punctuation">[</span>compileResult<span class="token punctuation">.</span>ngModuleFactoryVar<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_compiledNgModuleCache<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>moduleMeta<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token punctuation">.</span>reference<span class="token punctuation">,</span> ngModuleFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ngModuleFactory<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">|</span>
</code></pre></div><p>可以看到：</p> <ul><li><code>AotCompiler</code>中更多是直接将作用域/上下文、元数据信息直接用于模块的创建，少了编译过程</li> <li><code>JitCompiler</code>中会在运行时创建作用域、上下文，并通过编译过程获取需要的元数据，然后再进行模块的创建</li></ul> <p>我们来分别看看 AOT 编译的三个阶段。</p> <h3 id="aot-编译阶段"><a href="#aot-编译阶段" class="header-anchor">#</a> AOT 编译阶段</h3> <p>AOT 编译分为三个阶段：</p> <p>**一、代码分析。**在此阶段，TypeScript 编译器和 AOT 收集器会创建源码的表现层。</p> <p>TypeScript 编译器会做一些初步的分析工作，它会生成类型定义文件<code>.d.ts</code>，其中带有类型信息，Angular 编译器需要借助它们来生成代码：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">StaticSymbolResolverHost</span> <span class="token punctuation">{</span>
  <span class="token comment">// 返回给定模块的 ModuleMetadata</span>
  <span class="token comment">// Angular CLI 会在生成 .d.ts 文件并且模块导出变量或带有装饰器的类时为模块生成元数据</span>
  <span class="token comment">// 模块元数据也可以通过在 tools/metadata 中使用 MetadataCollector 直接从 TypeScript 源生成</span>
  <span class="token function">getMetadataFor</span><span class="token punctuation">(</span>modulePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同时，AOT 收集器（<code>collector</code>）会记录 Angular 装饰器中的元数据，并把它们输出到<code>.metadata.json</code>文件（可以把<code>.metadata.json</code>文件看做一个包括全部装饰器的元数据的全景图）中，和每个<code>.d.ts</code>文件相对应：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 从 TypeScript 模块收集装饰器元数据</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MetadataCollector</span> <span class="token punctuation">{</span>
  <span class="token comment">// 返回一个 JSON.stringify 友好形式</span>
  <span class="token comment">// 描述源文件中导出的类的装饰器，该类预期与模块相对应</span>
  <span class="token keyword">public</span> <span class="token function">getMetadata</span><span class="token punctuation">(</span>
    sourceFile<span class="token operator">:</span> ts<span class="token punctuation">.</span>SourceFile<span class="token punctuation">,</span>
    strict<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    substituteExpression<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>
      value<span class="token operator">:</span> MetadataValue<span class="token punctuation">,</span>
      node<span class="token operator">:</span> ts<span class="token punctuation">.</span>Node
    <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> MetadataValue
  <span class="token punctuation">)</span><span class="token operator">:</span> ModuleMetadata <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>收集器不会试图理解它收集并输出到<code>.metadata.json</code>中的元数据，它所能做的只是尽可能准确的表述这些元数据，并在检测到元数据中的语法违规时记录这些错误。解释这些<code>.metadata.json</code>是编译器在代码生成阶段要承担的工作。</p> <p>**二、代码生成。**在此阶段，编译器的<code>StaticReflector</code>会解释在 1 中收集的元数据，对元数据执行附加验证，如果检测到元数据违反了限制，则抛出错误。</p> <p><code>StaticReflector</code>静态反射器实现了足够多的反射器 API，这是静态编译模板所必需的：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">StaticReflector</span> <span class="token keyword">implements</span> <span class="token class-name">CompileReflector</span> <span class="token punctuation">{</span>
  <span class="token comment">// 元数据相关的静态符号缓存</span>
  <span class="token keyword">private</span> annotationCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span>StaticSymbol<span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> shallowAnnotationCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span>StaticSymbol<span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> propertyCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span>StaticSymbol<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> parameterCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span>StaticSymbol<span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> methodCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span>StaticSymbol<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">}</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> staticCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span>StaticSymbol<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 解释元数据</span>
  <span class="token function">componentModuleUrl</span><span class="token punctuation">(</span>typeOrFunc<span class="token operator">:</span> StaticSymbol<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">resolveExternalReference</span><span class="token punctuation">(</span>
    ref<span class="token operator">:</span> o<span class="token punctuation">.</span>ExternalReference<span class="token punctuation">,</span>
    containingFile<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> StaticSymbol <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">findDeclaration</span><span class="token punctuation">(</span>
    moduleUrl<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    containingFile<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> StaticSymbol <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">tryFindDeclaration</span><span class="token punctuation">(</span>
    moduleUrl<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    containingFile<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> StaticSymbol <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">findSymbolDeclaration</span><span class="token punctuation">(</span><span class="token builtin">symbol</span><span class="token operator">:</span> StaticSymbol<span class="token punctuation">)</span><span class="token operator">:</span> StaticSymbol <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// 验证元数据</span>
  <span class="token keyword">public</span> <span class="token function">tryAnnotations</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token operator">:</span> StaticSymbol<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">annotations</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token operator">:</span> StaticSymbol<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">shallowAnnotations</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token operator">:</span> StaticSymbol<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">propMetadata</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token operator">:</span> StaticSymbol<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">parameters</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token operator">:</span> StaticSymbol<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>编译器理解收集器支持的所有语法形式，但是它也可能拒绝那些虽然语法正确但语义违反了编译器规则的元数据。</p> <p>**三、模板类型检查。**在此可选阶段，Angular 模板编译器使用 TypeScript 编译器来验证模板中的绑定表达式。</p> <p>Angular 编译器最有用的功能之一就是能够对模板中的表达式进行类型检查，在由于出错而导致运行时崩溃之前就捕获任何错误。在模板类型检查阶段，Angular 模板编译器会使用 TypeScript 编译器来验证模板中的绑定表达式。</p> <p>当模板绑定表达式中检测到类型错误时，进行模板验证时就会生成错误。这和 TypeScript 编译器在处理<code>.ts</code>文件中的代码时报告错误很相似。</p> <h3 id="aot-的优势"><a href="#aot-的优势" class="header-anchor">#</a> AOT 的优势</h3> <p>显然，使用 AOT 编译有这些好处：</p> <ol><li>更快的渲染：借助 AOT，浏览器可以下载应用的预编译版本。浏览器加载的是可执行代码，因此它可以立即渲染应用，而无需等待先编译好应用。</li> <li>更少的异步请求：编译器会在应用 JavaScript 中内联外部 HTML 模板和 CSS 样式表，从而消除了对那些源文件的单独 ajax 请求。</li> <li>较小的 Angular 框架下载大小：如果已编译应用程序，则无需下载 Angular 编译器。编译器大约是 Angular 本身的一半，因此省略编译器会大大减少应用程序的有效载荷。</li> <li>尽早检测模板错误：AOT 编译器会在构建步骤中检测并报告模板绑定错误，然后用户才能看到它们。</li> <li>更高的安全性：AOT 在将 HTML 模板和组件提供给客户端之前就将其编译为 JavaScript 文件。没有要读取的模板，没有潜藏风险的客户端 HTML 或 JavaScript eval，受到注入攻击的机会就更少了。</li></ol> <p>在 AOT 模式下，生成的包不再包含 HTML 模板，而是直接包含已编译的模板。如果检查由构建生成的文件<code>main.bundle.js</code>，会发现包含已编译模板的代码部分。</p> <p>在同一个应用程序中，AOT 编译生成以下包：</p> <ul><li>main.bundle.js : 59k (27k 缩小)</li> <li>vendor.bundle.js：2281k（610k 缩小）</li></ul> <p>可以看到，<code>vendor.bundle.js</code>的大小大大减少，因为它不再包含编译器。这种编译的优点很明显：减少应用程序负载、更少的请求、快速渲染。</p> <h2 id="结束语"><a href="#结束语" class="header-anchor">#</a> 结束语</h2> <p>本文介绍了 Angular 中的 JIT/AOT 编译过程和工作原理，看起来似乎这些都和 Ivy 编译器关系不大。实际上，要实现 JIT、AOT 编译，核心便是 Ivy 编译器。在 View Engine 中虽然也有 JIT/AOT 的两种模式，但不管是装饰器元数据的解析，还是模板编译过程中的类型错误检查，在 Ivy 编译器的设计里都有非常大的区别。</p> <h3 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h3> <ul><li><a href="https://angular.cn/guide/aot-compiler" target="_blank" rel="noopener noreferrer">预先（AOT）编译器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://medium.com/@kadrimoujib/angular-jit-vs-aot-15e211d94966" target="_blank" rel="noopener noreferrer">Angular JiT vs AoT<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <!----> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/godbasin/front-end-playground/edit/sourcecode/docs/angular/deep-into-angular/angular-design-ivy-4-aot-jit.md" target="_blank" rel="noopener noreferrer">帮阿猪改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <blockquote>部分文章中使用了一些网站的截图，如果涉及侵权，请告诉我删一下谢谢~</blockquote> <div style="margin-top:30px;"><div class="el-row" style="margin-left:-10px;margin-right:-10px;"><div class="el-col el-col-24 el-col-sm-0 el-col-md-2 el-col-lg-4" style="padding-left:10px;padding-right:10px;display:block;"><div style="width:1px;height:1px;"></div></div> <div class="el-col el-col-24 el-col-sm-24 el-col-md-18 el-col-lg-16" style="padding-left:10px;padding-right:10px;"><div class="el-card box-card is-always-shadow"><div class="el-card__header"><div class="clearfix"><span>温馨提示喵</span></div></div><div class="el-card__body"> <div class="el-row" style="margin-left:-10px;margin-right:-10px;"><div class="el-col el-col-24 el-col-xs-24 el-col-sm-12" style="padding-left:10px;padding-right:10px;"><div class="el-image"><div class="image-slot"><img src="https://github-imglib-1255459943.cos.ap-chengdu.myqcloud.com/assets/img/loading.gif" style="width:100%;"></div><!----></div></div> <div class="el-col el-col-24 el-col-xs-24 el-col-sm-12" style="padding-left:10px;padding-right:10px;"><div class="copyright-text"><div>本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</div> <div>出处：被删的前端游乐场</div> <div>作者：<a href="https://github.com/godbasin" target="_blank">被删</a></div></div></div></div></div></div></div></div></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/front-end-playground/angular/deep-into-angular/angular-design-ivy-3-mental-model.html" class="prev">
          12.Ivy编译器之心智模型
        </a></span> <span class="next"><a href="/front-end-playground/angular/deep-into-angular/angular-design-ivy-5-incremental-dom.html">
          14.Ivy编译器之增量DOM
        </a>
        →
      </span></p></div>  <div class="gitalk-container theme-default-content"><div id="gitalk-container" class="content"></div></div></main> <div id="kitty-container"><span><div role="tooltip" id="el-popover-7023" aria-hidden="true" class="el-popover el-popper" style="width:undefinedpx;display:none;"><!----><img src="https://github-imglib-1255459943.cos.ap-chengdu.myqcloud.com/2code2.jpg" class="image"> <div class="text">牡羊猪的猫粮罐</div> </div><span class="el-popover__reference-wrapper"><div id="kitty" style="background:url(https://github-imglib-1255459943.cos.ap-chengdu.myqcloud.com/assets/img/kitty1.svg);"></div></span></span> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="牡羊猪是这样渐渐胖成猪的喵（点击图片可以切换噢）" class="el-dialog" style="margin-top:15vh;"><div class="el-dialog__header"><span class="el-dialog__title">牡羊猪是这样渐渐胖成猪的喵（点击图片可以切换噢）</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><!----></div></div></div></div><div class="global-ui"></div></div>
    <script src="/front-end-playground/assets/js/app.c4b53b67.js" defer></script><script src="/front-end-playground/assets/js/2.e5aa9928.js" defer></script><script src="/front-end-playground/assets/js/3.ab142917.js" defer></script><script src="/front-end-playground/assets/js/32.26c2dfa8.js" defer></script>
  </body>
</html>
