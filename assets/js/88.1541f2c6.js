(window.webpackJsonp=window.webpackJsonp||[]).push([[88],{649:function(t,s,a){"use strict";a.r(s);var n=a(69),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("前面跟大家介绍过"),a("RouterLink",{attrs:{to:"/front-end-basic/performance/front-end-performance-no-response-solution.html"}},[t._v("前端性能卡顿的检测和监控")]),t._v("，其中提到了"),a("code",[t._v("requestAnimationFrame")]),t._v("心跳检测等方式来检测代码执行耗时，从而判断是否存在卡顿。")],1),t._v(" "),a("p",[t._v("而实际上我们观察一些用户反馈，会发现这样检测的效果并不是很理想。")]),t._v(" "),a("h1",{attrs:{id:"用户感觉的-卡"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用户感觉的-卡"}},[t._v("#")]),t._v(" 用户感觉的“卡”")]),t._v(" "),a("p",[t._v("一般来说，我们会根据代码检测的任务耗时超过一定值判断为卡顿，比如超过 1s 的长任务。但实际上，这样的方法难以准确命中“用户侧卡顿”的场景，这是因为：")]),t._v(" "),a("ul",[a("li",[t._v("超过 1s 的任务执行时，用户未必在进行页面操作，未感受到“卡顿”")]),t._v(" "),a("li",[t._v("对用户来说，在浏览器中各个过程中的卡顿阈值是不一致的，比如：\n"),a("ul",[a("li",[t._v("页面打开过程中，会习惯性地等待，此时卡顿阈值会稍微高一些")]),t._v(" "),a("li",[t._v("页面加载完成后，对各种功能的操作响应更敏感，希望能快速响应操作")])])])]),t._v(" "),a("p",[t._v("因此，我们可以重新定义卡顿指标，可以将其分为两种：")]),t._v(" "),a("ol",[a("li",[t._v("技术侧卡顿（代码长任务）。")]),t._v(" "),a("li",[t._v("用户侧卡顿（交互响应耗时）。")])]),t._v(" "),a("p",[t._v("本文我们重点来探讨用户侧卡顿的检测。")]),t._v(" "),a("h2",{attrs:{id:"用户侧卡顿"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用户侧卡顿"}},[t._v("#")]),t._v(" 用户侧卡顿")]),t._v(" "),a("p",[t._v("如果你有认真整理用户反馈，便会发现，对于大型应用比如在线表格/网页游戏等，相比于加载过程中偶尔一两秒的卡顿，更让他们难以接受的问题有频繁出现卡顿、某个操作卡顿耗时过长、某个较频繁的操作必现卡顿等。")]),t._v(" "),a("p",[t._v("那么，我们可以基于这些场景，重新定义用户侧卡顿的指标，满足以下场景均可认为产生了卡顿：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("问题")]),t._v(" "),a("th",[t._v("对应性能指标")]),t._v(" "),a("th",[t._v("指标定义")]),t._v(" "),a("th",[t._v("补充说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("操作后响应不及时")]),t._v(" "),a("td",[t._v("用户交互（点击）后，rAF 响应耗时 > 1000ms")]),t._v(" "),a("td",[t._v("交互卡顿")]),t._v(" "),a("td",[t._v("类似 INP（参考 https://web.dev/articles/inp），但滚动行为考虑在内")])]),t._v(" "),a("tr",[a("td",[t._v("操作（编辑/滚动）频繁出现卡顿")]),t._v(" "),a("td",[t._v("20s 内，交互响应卡顿次数 > 5")]),t._v(" "),a("td",[t._v("交互卡顿频率")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("某个操作卡顿耗时过长，长达 5s/10s 甚至更多")]),t._v(" "),a("td",[t._v("- 交互响应卡顿耗时 > 5s")]),t._v(" "),a("td"),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("- 交互响应卡顿耗时 > 10s")]),t._v(" "),a("td",[t._v("交互长耗时卡顿")]),t._v(" "),a("td"),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("某个较频繁的操作必现卡顿")]),t._v(" "),a("td",[t._v("相同的卡顿埋点次数 > 5")]),t._v(" "),a("td",[t._v("同因交互卡顿")]),t._v(" "),a("td")])])]),t._v(" "),a("p",[t._v("这里有一个难处理的地方：如何判断用户交互后产生了卡顿呢？因为我们可以拆分成以下情况：")]),t._v(" "),a("ol",[a("li",[t._v("用户交互后，同步执行长耗时任务产生卡顿。")]),t._v(" "),a("li",[t._v("用户交互后，异步执行逻辑的时候产生卡顿。")])]),t._v(" "),a("h3",{attrs:{id:"_1-同步任务卡顿"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-同步任务卡顿"}},[t._v("#")]),t._v(" 1. 同步任务卡顿")]),t._v(" "),a("p",[t._v("我们可以在监听到用户交互时进行耗时计算：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"click"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" startTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Date")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getTime")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("requestAnimationFrame")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" duringTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Date")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getTime")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" startTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 交互后超过 1s 才响应")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("duringTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 则判断为卡顿")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"_2-异步任务卡顿"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-异步任务卡顿"}},[t._v("#")]),t._v(" 2. 异步任务卡顿")]),t._v(" "),a("p",[t._v("对于异步任务，由于卡顿发生在用户交互后，难以通过代码直接发现。我们可以从另外一个角度分析，即当页面交互发生卡顿时，用户常常会在页面中进行操作，来确认页面是否无响应。因此，我们可以通过这样的代码判断：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" clickCount "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" hasClick "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nwindow"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"click"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  clickCount"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hasClick"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  hasClick "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 卡顿过程中发生了连续点击操作")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("clickCount "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 则判断为卡顿")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 清空数据")]),t._v("\n    clickCount "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    hasClick "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"总卡顿指标设计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总卡顿指标设计"}},[t._v("#")]),t._v(" 总卡顿指标设计")]),t._v(" "),a("p",[t._v("综上所述，我们会将以下情况作为一次卡顿的产生，并且做卡顿次数的上报：")]),t._v(" "),a("ul",[a("li",[t._v("用户交互后，同步卡顿超过 1s")]),t._v(" "),a("li",[t._v("检测到一次宏任务中，用户连续点击操作超过 5 次")])]),t._v(" "),a("p",[t._v("同时，我们可以在特特定场景发生的时候，将数据以及日志同时进行上报，比如：")]),t._v(" "),a("ul",[a("li",[t._v("20s 内产生卡顿次数 > 5")]),t._v(" "),a("li",[t._v("检测到某段代码执行超过 5s/10s")]),t._v(" "),a("li",[t._v("检测到卡顿埋点中卡顿（超过 1s）的相同埋点多次产生（相同的卡顿埋点次数 > 5）")])]),t._v(" "),a("p",[t._v("通过这样的方式，我们可以判断用户是否产生了卡顿。但实际上要如何定位卡顿的位置呢，还是得通过日志和埋点进行，可以参考"),a("RouterLink",{attrs:{to:"/front-end-basic/performance/front-end-performance-no-response-solution.html"}},[t._v("《前端性能优化--卡顿的监控和定位》")]),t._v("一文。")],1),t._v(" "),a("h1",{attrs:{id:"结束语"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#结束语"}},[t._v("#")]),t._v(" 结束语")]),t._v(" "),a("p",[t._v("很多时候，我们开发在实现功能的时候，常常会从编程出发去思考问题，但实际上我们可以更贴近用户一些滴~")])])}),[],!1,null,null,null);s.default=e.exports}}]);